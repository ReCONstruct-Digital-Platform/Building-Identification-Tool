{% extends 'buildings/base.html' %}

{% block content %}
{% load humanize %}

{{ building_latest_view_data | json_script:"building_latest_view_data" }}

<!-- Hack to augment the creation of all WebGL contexts with preserveDrawingBuffer=true -->
<!-- This is done so we can take a screenshot  -->
<!-- https://stackoverflow.com/questions/26783586/canvas-todataurl-returns-blank-image  -->
<script>
  HTMLCanvasElement.prototype.getContext = function(origFn) {
    return function(type, attributes) {
      if (type === 'webgl') {
        attributes = Object.assign({}, attributes, {
          preserveDrawingBuffer: true,
        });
      }
      return origFn.call(this, type, attributes);
    };
  }(HTMLCanvasElement.prototype.getContext);
</script>

<script src="{% static 'scripts/map.js' %}"></script>
<script src="{% static 'scripts/html2canvas.min.js' %}"></script>
<script>
    var map;
    var sv;
    var m_marker;
    var sv_marker;

    var panoRequest;
    var building_coord;


    function initMaps() {
      const svService = new google.maps.StreetViewService();

      // If we have already seen the building, get the latest user defined view
      const building_latest_view_data = JSON.parse(document.getElementById('building_latest_view_data').textContent);

      if (building_latest_view_data) {
        panoRequest = {
          pano: building_latest_view_data['sv_pano']
        };

        building_coord = {
          lat: building_latest_view_data['marker_lat'], 
          lng: building_latest_view_data['marker_lng']
        };
      }
      // No preivously saved view data
      // we will search for best panorama
      else {
        building_coord = {
          lat: parseFloat("{{ building.lat }}"), 
          lng: parseFloat("{{ building.lon }}")
        };

        panoRequest = {
          location: building_coord,
          preference: google.maps.StreetViewPreference.BEST,
          radius: 50,
          source: google.maps.StreetViewSource.OUTDOOR
        };
      }

      function findPanoramaByRadius(panoRequest, building_coord) {

        console.log(`Searching using radius`);

        svService.getPanorama(panoRequest, function(panoData, status) {
          if (status === google.maps.StreetViewStatus.OK) {

            console.log("Found Panorama")
            // Calculate the correct direction the camera must face
            // based on the panorama default location and the building location
            const heading = google.maps.geometry.spherical.computeHeading(panoData.location.latLng, building_coord);

            sv = new google.maps.StreetViewPanorama(
              document.getElementById('streetview'),
              {
                  position: building_coord,
                  center: building_coord,
                  zoom: 0,
                  pov: {
                    heading: heading,
                    pitch: 0,
                  },
                  linksControl: false,
                  panControl: false,
                  fullscreenControl: false,
                  addressControl: false,
                  zoomControl: false,
              });
            
              sv_marker = new google.maps.Marker({
                position: building_coord,
                map: sv,
                title: "Building",
                draggable: true,
              });

              sv_marker.addListener("dragend", ()=> {
                m_marker.setPosition(sv_marker.getPosition());
              })
              
              // Setting the panorama after the marker has been defined,
              // otherwise the marker does not show for some reason!
              // https://stackoverflow.com/questions/23498921/google-street-view-with-custom-panorama-and-markers
              sv.setPano(panoData.location.pano);
              window.sv = sv;

              map = new google.maps.Map(document.getElementById("satmap"), {
                center: building_coord,
                mapTypeId: 'satellite',
                zoom: 18,
                // streetViewControl: false,
                rotateControl: false,
                controlSize: 25,
              });

              m_marker = new google.maps.Marker({
                position: building_coord,
                map: map,
                draggable: true,
              });

              map.setStreetView(sv);
              window.map = map;

              // Listen to the marker being dragged and update the one on the streetview to match
              m_marker.addListener("dragend", ()=> {
                sv_marker.setPosition(m_marker.getPosition());
              })
          } 
          else {
            var radius = panoRequest.radius
            //Handle other statuses here
            if (radius > 200) {
              console.log(`Could not find a street view within ${radius}m of building! Giving up.`);
              elem = document.createElement('div');
              elem.innerText = "Could not find Panorama for location";
              document.getElementById("streetview").appendChild(elem);
              return False;
            } 
            else {
              console.log(`Could not find street view within ${radius}m, trying again within ${radius+50}m.`)
              panoRequest.radius = panoRequest.radius + 50; 
              findPanoramaByRadius(panoRequest, building_coord);
            }
          }
        });
        }

      function findPanoramaById(panoRequest, building_coord) {
        console.log(`Searching for panorama using Id: ${panoRequest.pano}`);

        svService.getPanorama(panoRequest, function(panoData, status) {
          if (status === google.maps.StreetViewStatus.OK) {

            const heading = building_latest_view_data['sv_heading'];
            const zoom = building_latest_view_data['sv_zoom'];
            const pitch = building_latest_view_data['sv_pitch'];

            sv = new google.maps.StreetViewPanorama(
              document.getElementById('streetview'),
              {
                  position: building_coord,
                  center: building_coord,
                  zoom: zoom,
                  pov: {
                    heading: heading,
                    pitch: pitch,
                  },
              });
            
              sv_marker = new google.maps.Marker({
                position: building_coord,
                map: sv,
                title: "Building",
                draggable: true,
              });

              sv_marker.addListener("dragend", ()=> {
                m_marker.setPosition(sv_marker.getPosition());
              })
              
              // Setting the panorama after the marker has been defined,
              // otherwise the marker does not show for some reason!
              // https://stackoverflow.com/questions/23498921/google-street-view-with-custom-panorama-and-markers
              sv.setPano(panoData.location.pano);
              window.sv = sv;

              map = new google.maps.Map(document.getElementById("satmap"), {
                center: building_coord,
                mapTypeId: 'satellite',
                zoom: 18,
                // streetViewControl: false,
                rotateControl: false,
                controlSize: 25,
              });

              m_marker = new google.maps.Marker({
                position: building_coord,
                map: map,
                draggable: true,
              });

              map.setStreetView(sv);
              window.map = map;

              // Listen to the marker being dragged and update the one on the streetview to match
              m_marker.addListener("dragend", ()=> {
                sv_marker.setPosition(m_marker.getPosition());
              })
          } 
          else {
            console.log(`Could not find panorama id ${panoRequest.pano}. Searching using radius`);
            // Making a radius search request
            panoRequest = {
              location: building_coord,
              preference: google.maps.StreetViewPreference.BEST,
              radius: 50,
              source: google.maps.StreetViewSource.OUTDOOR
            };
            return findPanoramaByRadius(panoRequest, building_coord);
          }
        });
      }
      
      if (building_latest_view_data)
        findPanoramaById(panoRequest, building_coord);
        else  
        findPanoramaByRadius(panoRequest, building_coord);
    } 

    window.initMaps = initMaps;
</script>

<section class="container-wide mb-3">
  <div class="classify-top-row">
    <div class="building-nav building-nav-left">
      <a id="prev-building-link">&laquo;&laquo; Prev</a>
    </div>
    <div class="building-info">

      <div class="building-info-col">
        <div class="building-id">
          <h4>
            Building #{{ building.id }} 
          </h4>
        </div>
        <div>
          {{ building.formatted_address }}
        </div>
        <div class="building-cubf">
          CUBF {{ building.cubf }}: {{ building.cubf_name }} 
        </div>
      </div>
      <div class="building-info-col ml-5">
        <div>
          Const. year: 
          {% if building.construction_year != 9999 %}
            {{ building.construction_year }}
            {% if building.year_real_esti == 'E' %}
            (Est.)
            {% endif %}
          {% else %}
          &mdash;
          {% endif %}
        </div>
        <div>
          Max floors: 
          {% if building.max_num_floor %}
          {{ building.max_num_floor }}
          {% else %}
          &mdash;
          {% endif %}
        </div>
        <div>
          Floor area: 
          {% if building.floor_area != 9999.0 %}
          {{ building.floor_area }} m<sup>2</sup>
          {% else %}
          &mdash;
          {% endif %}
        </div>
      </div>

      <div class="building-info-col ml-5">
        <div>
          Type const.: 
          {% if building.type_const %}

          {% include "buildings/utils/construction_type.html" with type_const=building.type_const %}

          {% else %}
          &mdash;
          {% endif %}
        </div>
        <div>
          Property value: ${{ building.value_prop|intcomma }}
        </div>
        <div>
          Non-res premises: 
          {% if building.num_non_res %}
          
          {{ building.num_non_res }}
          {% else %}
          &mdash;
          {% endif %}
        </div>
      </div>
      <button id="btn-no-building" type="button" class="btn btn-danger btn-no-building ml-5">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-exclamation-triangle-fill" viewBox="0 -2 16 17">
          <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
        </svg>
        No Building
      </button>
      <button id="btn-screenshot" type="button" class="btn btn-primary btn-screenshot ml-3">
        <svg fill="#ffffff" width="16" height="16" viewBox="0 -6 32 32" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid">
          <path d="M29.000,26.000 L3.000,26.000 C1.346,26.000 -0.000,24.654 -0.000,23.000 L-0.000,7.000 C-0.000,5.346 1.346,4.000 3.000,4.000 L7.381,4.000 L9.102,0.554 C9.270,0.214 9.617,0.000 9.996,0.000 L22.006,0.000 C22.385,0.000 22.731,0.214 22.901,0.554 L24.619,4.000 L29.000,4.000 C30.654,4.000 32.000,5.346 32.000,7.000 L32.000,23.000 C32.000,24.654 30.654,26.000 29.000,26.000 ZM30.000,7.000 C30.000,6.449 29.551,6.000 29.000,6.000 L24.000,6.000 C23.950,6.000 23.907,5.979 23.859,5.972 C23.788,5.961 23.717,5.955 23.649,5.929 C23.588,5.906 23.537,5.869 23.482,5.834 C23.428,5.801 23.373,5.773 23.326,5.729 C23.273,5.680 23.235,5.620 23.194,5.560 C23.166,5.520 23.127,5.491 23.105,5.446 L21.387,2.000 L10.615,2.000 L8.895,5.446 C8.848,5.541 8.785,5.623 8.715,5.695 C8.701,5.710 8.684,5.719 8.669,5.733 C8.597,5.798 8.518,5.851 8.432,5.892 C8.403,5.907 8.375,5.919 8.344,5.931 C8.234,5.971 8.120,5.999 8.002,6.000 C8.001,6.000 8.001,6.000 8.000,6.000 L3.000,6.000 C2.449,6.000 2.000,6.449 2.000,7.000 L2.000,23.000 C2.000,23.551 2.449,24.000 3.000,24.000 L29.000,24.000 C29.551,24.000 30.000,23.551 30.000,23.000 L30.000,7.000 ZM16.000,21.000 C12.140,21.000 9.000,17.860 9.000,14.000 C9.000,10.140 12.140,7.000 16.000,7.000 C19.860,7.000 23.000,10.140 23.000,14.000 C23.000,17.860 19.860,21.000 16.000,21.000 ZM16.000,9.000 C13.243,9.000 11.000,11.243 11.000,14.000 C11.000,16.757 13.243,19.000 16.000,19.000 C18.757,19.000 21.000,16.757 21.000,14.000 C21.000,11.243 18.757,9.000 16.000,9.000 Z"/>
      </svg>
        Screenshot
      </button>
    </div>
    <div class="building-nav building-nav-right">
      <a id="next" href="{% url 'buildings:classify' next_building %}">Next &raquo;&raquo;</a>
    </div>
  </div>
</section>

<section class="container-wide">
  <div class="streetview-and-map-container">
    <div class="streetview-container ml-3">
      <div id="streetview"></div>
    </div>
    <div id="dragbar"></div>
    <div class="map-and-submit-container mr-3">
      <div class="building-selection">
        <form id="building-submition-form" action="{% url 'buildings:classify' building.id %}" method="post">
          {% csrf_token %}
          <input type="hidden" name="latest_view_data" id="latest_view_data"/>

          <div class="building-selection-row">
            <table id="vote-table" class="table vote-table">
              <thead class="thead-light">
                <tr>
                  <th scope="col"></th>
                  <th scope="col">No</th>
                  <!-- <th scope="col">Unlikely</th> -->
                  <th scope="col">Unclear</th>
                  <!-- <th scope="col">Likely</th> -->
                  <th scope="col">Yes</th>
                </tr>
              </thead>
              <tbody>
                <tr id="row-1">
                  <input type="hidden" name = "typology" value="prefab_metal_barn"/>
                  <td scope="row">
                    Prefab metal building?
                  </td>
                  <td class="td-vote">
                    <input type="radio" name="typology" value="1" required/></td>
                  <!-- <td class="td-vote">
                    <input type="radio" name="typology" value="2"/></td> -->
                  <td class="td-vote">
                    <input type="radio" name="typology" value="3"/></td>
                  <!-- <td class="td-vote">
                    <input type="radio"name="typology" value="4"/></td> -->
                  <td class="td-vote">
                    <div class="td-vote-last-cell">
                      <input type="radio" name="typology" value="5"/>
                    </div>
                  </td>
                </tr>
                <tr id="row-2">
                  <td>
                    Additonal Notes:
                  </td>
                  <td colspan="3">
                    <textarea  class="note-input" name="note" placeholder="Enter notes..."></textarea>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
            <div class="btn-row">
              <input id="btn-submit-vote" class="btn btn-vote mr-5" type="submit" value="Submit">
            </div>
        </form>
      </div>
      <div class="map-container">
        <div id="satmap"></div>
      </div>
    </div>
  </div>  
  <script src="https://maps.googleapis.com/maps/api/js?key={{key}}&libraries=geometry&callback=initMaps&v=weekly" defer></script>
</section>




{% endblock content %}
