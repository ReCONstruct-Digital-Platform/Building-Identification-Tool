{% extends 'buildings/base.html' %}

{% block content %}
{% load humanize %}

<script src="{% static 'scripts/map.js' %}"></script>
<script> 
    function initMaps() {
      // Get the values from django
      const lat = parseFloat("{{ building.lat }}");
      const lon = parseFloat("{{ building.lon }}");

      const building_coord = { lat: lat, lng: lon };

      const svService = new google.maps.StreetViewService();

      const panoRequest = {
        location: building_coord,
        preference: google.maps.StreetViewPreference.BEST,
        radius: 50,
        source: google.maps.StreetViewSource.OUTDOOR
      };

      const findPanorama = function(radius) {
        panoRequest.radius = radius;
        svService.getPanorama(panoRequest, function(panoData, status) {

          if (status === google.maps.StreetViewStatus.OK) {
            // Calculate the correct direction the camera must face
            // based on the panorama default location and the building location
            const heading = google.maps.geometry.spherical.computeHeading(panoData.location.latLng, building_coord);

            const streetview = new google.maps.StreetViewPanorama(
              document.getElementById('street-view'),
              {
                  position: building_coord,
                  center: building_coord,
                  zoom: 0,
                  pov: {
                    heading: heading,
                    pitch: 0,
                  },
              });
            
              const buildingMarker = new google.maps.Marker({
                position: building_coord,
                map: streetview,
                title: "Building",
              });
              
              // Setting the panorama after the marker has been defined,
              // otherwise the marker does not show for some reason!
              // https://stackoverflow.com/questions/23498921/google-street-view-with-custom-panorama-and-markers
              streetview.setPano(panoData.location.pano);
          } 
          else {
            //Handle other statuses here
            if (radius > 200) {
              console.log(`Could not find a street view within ${radius}m of building! Giving up.`);
              return False;
            } 
            else {
              console.log(`Could not find street view within ${radius}m, trying again within ${radius+50}m.`)
              findPanorama(radius + 50);
            }
          }
        });
      };
      // Call the function with 50m radius by default
      findPanorama(50);

      const map = new google.maps.Map(document.getElementById("map"), {
        center: building_coord,
        mapTypeId: 'satellite',
        zoom: 18,
      });

      const marker = new google.maps.Marker({
        position: building_coord,
        map: map,
      });

    }
    window.initMaps = initMaps;
</script>

<section class="container-wide">
  <div class="classify-top-row">
    <div class="building-nav building-nav-left">
      <a id="prev-building-link">&laquo;&laquo; Prev</a>
    </div>
    <div class="building-info">
      <div class="building-id-and-report">
        <div class="building-id">
          <h3>
            Building #{{ building.id }}
          </h3>
          <span class="serial-cubf ml-2">
            ({{ building.serial_number }})
          </span>
        </div>
        <!-- <div class="report-building">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-exclamation-triangle-fill" viewBox="0 0 16 16">
            <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
          </svg>
          Report bad data
        </div> -->
        <div class="building-cubf ml-2">
          CUBF {{ building.cubf }}: {{ building.cubf_name }} 
        </div>
      </div>
      <div class="building-address">
        <p>
          {{ building.formatted_address }}
        </p> 
      </div>
    </div>
    <div class="building-nav building-nav-right">
      <!-- <div>
        <a id="prev-building-link">&laquo;&laquo; Prev</a>
      </div> -->
        <a id="next" href="{% url 'buildings:classify' next_building %}">Next &raquo;&raquo;</a>
    </div>
  </div>
</section>

<section class="container-wide">
  <div class="maps-container">
    <div class="streetview-container ml-3 mr-1">
      <div id="street-view"></div>
    </div>
    <div class="info-and-satellite-view mt-3 mr-3">
      <div id="info">
        Additional Info:
        <ul>
          {% if building.construction_year %} 
          <li>
            Construction year:  {{ building.construction_year }} 
            {% if building.year_real_esti == 'E' %}
            (Est.)
            {% endif %}
            {% else %}
            {% endif %}
          </li>
          {% if building.max_num_floor %}
          <li>
            Max floors: {{ building.max_num_floor }}
          </li>
          {% endif %}
          {% if building.floor_area and building.floor_area != 9999.0 %}
          <li>
            Floor area: {{ building.floor_area }} m<sup>2</sup>
          </li>
          {% endif %}
          {% if building.type_const %}
          <li>
            Type const.: {{ building.type_const }}
          </li>
          {% endif %}
          {% if building.num_non_res %}
          <li>
            Non-residential premises: {{ building.num_non_res }}
          </li>
          {% endif %}
          {% if building.value_prop %}
          <li>
            Property value: ${{ building.value_prop|intcomma }}
          </li>
          {% endif %}
        </ul>
      </div>
      <div id="map"></div>
    </div>
    <!-- Uncomment to activate streetview container - will incur API cost -->
  </div>  
  <script src="https://maps.googleapis.com/maps/api/js?key={{key}}&libraries=geometry&callback=initMaps&v=weekly" defer></script>
</section>

<section class="container bottom-section">
  <div class="building-selection mt-3">
    <form action="{% url 'buildings:classify' building.id %}" method="post">
      {% csrf_token %}
      <legend>
        <p>
          Is this a prefab metal building?
        </p>
      </legend>
        <table id="vote-table" class="table vote-table">
          <thead class="thead-light">
            <tr>
              <th scope="col"></th>
              <th scope="col">Very Unlikely</th>
              <th scope="col">Unlikely</th>
              <th scope="col">Unclear</th>
              <th scope="col">Likely</th>
              <th scope="col">Very Likely</th>
            </tr>
          </thead>
          <tbody>
            <tr id="row-1">
              <th scope="row">
                <input type="hidden" name = "typology" value="prefab_metal_barn"/>
              </th>
              <td class="td-vote">
                <input type="radio" name="typology" value="1" required/></td>
              <td class="td-vote">
                <input type="radio" name="typology" value="2"/></td>
              <td class="td-vote">
                <input type="radio" name="typology" value="3"/></td>
              <td class="td-vote">
                <input type="radio"name="typology" value="4"/></td>
              <td class="td-vote">
                <div class="td-vote-last-cell">
                  <input type="radio" name="typology" value="5"/>
                </div>
              </td>
            </tr>
            <!-- Material vote row -->
            <!-- <tr id="row-1">
              <th class="material-name ml-2" scope="row">
                <select id="material-select-1" class="material-select" name="material-1">
                  {% for material in existing_materials %}
                  <option value="{{ material }}" {% if forloop.counter0 == 0 %}selected{%endif%}>{{ material }}</option>
                  {% endfor %}
                  <option value="new-material">New material</option>
                </select>
              </th>
              <th scope="Row"></th>
              <td class="td-vote">
                <input type="radio" name="material-1" value="1" required/></td>
              <td class="td-vote">
                <input type="radio" name="material-1" value="2"/></td>
              <td class="td-vote">
                <input type="radio" name="material-1" value="3"/></td>
              <td class="td-vote">
                <input type="radio" name="material-1" value="4"/></td>
              <td class="td-vote">
                <div class="td-vote-last-cell">
                  <input type="radio" name="material-1" value="5"/>
                </div>
              </td>
            </tr> -->
          </tbody>
        </table>
        <div id="note-container" class="note-container"></div>
        <div class="btn-row">
          <!-- <button id="btn-add-row"  type="button" class="btn">Add Material</button> -->
          <input id="btn-submit-vote" class="btn btn-vote mr-1" type="submit" value="Submit">
          <button id="btn-add-note" type="button" class="btn">Add Note</button>
        </div>
        <div class="classify-button-container mt-3">
        </div>
    </form>
  </div>
</section>

<!-- <div class="pageholder">

  

</div> -->

{{ existing_materials | json_script:"existing_materials" }}


{% endblock content %}
